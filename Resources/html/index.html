<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />

    <title>Weather example</title>

    <script src="../utils.js"></script>
    <script src="../gradients.js"></script>
    <script src="js/cities_lookup_table.js"></script>
    <link rel="stylesheet" href="js/lib/leaflet.css" />
    <script src="js/lib/leaflet.js"></script>
    <script src="js/lib/leaflet-dvf.js"></script>
    <script src="js/lib/jquery-1.11.1.min.js"></script>
    <meta name="viewport" content="width=320">
    <style>
        body {
            margin: 0;
            padding: 0;
        }
        div#map {
            width: 100%;
            position: absolute;
            top: 0;
            bottom: 0;
        }
        .leaflet-bottom {
            bottom: 50px;
        }
        .leaflet-top .leaflet-control {
            margin-top: 22px;
        }
    </style>
</head>

  <body>
    <div id="map"> </div>

    <script>

        osmLayer = new L.tileLayer("osm/{z}/{x}/{y}.png", {
            attribution: 'Tiles by <a href="http://stamen.com">Stamen</a>, data by <a href="http://openstreetmap.org">OpenStreetMap</a>',
            detectRetina: true,
            updateWhenIdle: false,
        });

        var map = new L.Map('map', {
            attributionControl: false,
            minZoom: 3, // looks for tiles with z of 4
            maxZoom: 7, // looks for tiles with z of 8
            maxBounds: [[34.196091, 19.62726], [81.851929, 191.010254]]
        });
        map.addLayer(osmLayer);
        L.control.attribution({position: 'bottomleft', prefix: ''}).addTo(map);

        var stops2gradient = function (stops) {
            return {
                vector: [
                    ['0%', '50%'],
                    ['100%', '50%']
                ],
                stops: [{
                    'offset': '0%',
                        'style': {
                        'color': stops[0],
                            'opacity': 1
                    }
                }, {
                    'offset': '100%',
                        'style': {
                        'color': stops[1],
                            'opacity': 1
                    }
                }]
            };
        };

        var rainbowStyle = {
            "color": "#fd297e",
            "opacity": 1,
            "weight": 0,
            "stroke": false
        };

        var cloudStyle = {
            "color": "#cccccc",
            "opacity": 0.65,
            "weight": 0,
            "stroke": false
        };

        var insertRainbows = function( data ){
            var dataLayer = new L.ChoroplethDataLayer(data, {
                recordsField: 'features',
                locationMode: L.LocationModes.GEOJSON,
                layerOptions: {
                    color: "#000000",
                    fillOpacity: 0.7,
                    opacity: 1,
                    stroke: false,
                    weight: 0
                },
                showLegendTooltips: false,
                displayOptions: {
                    "properties.gradient_stops": {
                        gradient: stops2gradient
                    }
                }
            });
            map.addLayer(dataLayer);
        };

        var showSpottedRainbows = function (data) {
            L.geoJson(data, {
                pointToLayer: function (feature, latlng) {
                    return L.circleMarker(latlng, {
                        radius: 8,
                        fillColor: "#00ff00",
                        color: "transparent",
                        stroke: false,
                        weight: 0,
                        opacity: 1,
                        fillOpacity: 1
                    });
                }

            }).addTo(map);
        };

        var initMap = function(cityName, spottedRainbowFeatures) {
            var cityName = cityName || 'Moscow';
            var spottedRainbowFeatures = spottedRainbowFeatures || {};
            var city = cityLookUpHash[cityName];
            map.setView(new L.LatLng(city.lat, city.lon), 5);

            showSpottedRainbows(spottedRainbowFeatures);
            $.getJSON("http://vps40616.public.cloudvps.com/latest/clouds.json", function( data ){
                L.geoJson(data.features, {
                    style: cloudStyle }).addTo(map);

                $.getJSON("http://vps40616.public.cloudvps.com/latest/rainbows.json", function( data ) {
                    L.geoJson(data.features,
                        {
                            style: rainbowStyle
                        }).addTo(map);
                });
            });
        };

    </script>
  </body>

</html>
